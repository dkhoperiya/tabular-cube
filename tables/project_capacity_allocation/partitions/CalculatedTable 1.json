{
  "name": "CalculatedTable 1",
  "source": {
    "type": "calculated",
    "expression": [
      "VAR min_year =",
      "    YEAR ( TODAY () ) - 2",
      "VAR max_year =",
      "    YEAR ( TODAY () ) + 2",
      "RETURN",
      "    UNION (",
      "        /* первая часть запроса - реальное распределение емкости пропорционально доходам*/",
      "        SELECTCOLUMNS (",
      "            FILTER (",
      "                CROSSJOIN (",
      "                    /*группируем ФОТ трайба по годам трайбам и версиям ставок*/",
      "                    SELECTCOLUMNS (",
      "                        FILTER (",
      "                            ADDCOLUMNS (",
      "                                SUMMARIZE (",
      "                                    FILTER (",
      "                                        Capacity,",
      "                                        YEAR ( Capacity[Date] ) >= min_year",
      "                                            && YEAR ( Capacity[date] ) <= max_year",
      "                                    ),",
      "                                    Dates[Year],",
      "                                    Capacity[TribeCode],",
      "                                    Capacity[BudgetRates_Version]",
      "                                ),",
      "                                \"TribeYearCapacity\", CALCULATE ( [Tribe Capacity Fot Rates] )",
      "                            ),",
      "                            [TribeYearCapacity] > 0",
      "                        ),",
      "                        \"Year1\", [Year],",
      "                        \"TribeCode1\", [TribeCode],",
      "                        \"BudgetRates_Version1\", [BudgetRates_Version],",
      "                        \"TribeYearCapacity\", [TribeYearCapacity]",
      "                    ),",
      "                    /*вычислеям показатели проектов на основании которых высчитывается доля ФОТа; которая будет отнесена на проект*/",
      "                    FILTER (",
      "                        ADDCOLUMNS (",
      "                            FILTER (",
      "                                ADDCOLUMNS (",
      "                                    CROSSJOIN (",
      "                                        SUMMARIZE ( milestones, Projects[project code], Projects[project_tribe_code] ),",
      "                                        FILTER (",
      "                                            VALUES ( Dates[Year] ),",
      "                                            Dates[Year] >= min_year",
      "                                                && Dates[Year] <= max_year",
      "                                        ),",
      "                                        VALUES ( 'Budget Rates Versions'[Budget Rates Version] )",
      "                                    ),",
      "                                    \"PlanActSumG6\", [Plan Act Sum G6]",
      "                                ),",
      "                                [PlanActSumG6] > 0",
      "                            ),",
      "                            \"PlanTransferCostOfWorks\", [Plan Transfer Cost of Works],",
      "                            \"PlanResoldExp\", [Plan Resold Exp],",
      "                            \"PlanSubcontrExp\", [Plan Subcontr Exp]",
      "                        ),",
      "                        [PlanActSumG6] > [PlanTransferCostofWorks] + [PlanResoldExp] + [PlanSubcontrExp]",
      "                    )",
      "                ),",
      "                /*соединяем таблицы*/",
      "                [TribeCode1] = [project_tribe_code]",
      "                    && [Year1] = [year]",
      "                    && [BudgetRates_Version1] = [Budget Rates Version]",
      "            ),",
      "            \"project_code\", [Project Code],",
      "            \"project_tribe_code\", [project_tribe_code],",
      "            \"year\", [Year],",
      "            \"Budget Rates Version\", [Budget Rates Version],",
      "            \"PlanActSumG6\", [PlanActSumG6],",
      "            \"PlanTransferCostOfWorks\", [PlanTransferCostOfWorks],",
      "            \"PlanResoldExp\", [PlanResoldExp],",
      "            \"PlanSubcontrExp\", [PlanSubcontrExp],",
      "            \"TribeYearCapacity\", [TribeYearCapacity]",
      "        ),",
      "        /*Вторая часть запроса - только проекты - трайбы с фейковым доходом*/",
      "        SELECTCOLUMNS (",
      "            FILTER (",
      "                CROSSJOIN (",
      "                    FILTER (",
      "                        ADDCOLUMNS (",
      "                            SUMMARIZE (",
      "                                FILTER (",
      "                                    Capacity,",
      "                                    YEAR ( Capacity[Date] ) >= min_year",
      "                                        && YEAR ( Capacity[date] ) <= max_year",
      "                                ),",
      "                                Dates[Year],",
      "                                Capacity[TribeCode],",
      "                                Capacity[BudgetRates_Version]",
      "                            ),",
      "                            \"TribeYearCapacity\", CALCULATE ( [Tribe Capacity Fot Rates] )",
      "                        ),",
      "                        [TribeYearCapacity] > 0",
      "                    ),",
      "                    (",
      "                        SUMMARIZE (",
      "                            FILTER ( projects, Projects[is_technical_tribe_project] ),",
      "                            Projects[Project Code],",
      "                            Projects[project_tribe_code]",
      "                        )",
      "                    )",
      "                ),",
      "                [TribeCode] = [project_tribe_code]",
      "            ),",
      "            \"project_code\", [Project Code],",
      "            \"project_tribe_code\", [project_tribe_code],",
      "            \"year\", [Year],",
      "            \"Budget Rates Version\", [BudgetRates_Version],",
      "            \"PlanActSumG6\", 0.01,",
      "            \"PlanTransferCostOfWorks\", BLANK (),",
      "            \"PlanResoldExp\", BLANK (),",
      "            \"PlanSubcontrExp\", BLANK (),",
      "            \"TribeYearCapacity\", [TribeYearCapacity]",
      "        )",
      "    )"
    ]
  }
}