{
  "name": "Fcst Transfer Cost of Works",
  "expression": [
    "VAR LastFactDate =",
    "    MAX ( DatesPlanFact[PF Date] )",
    "RETURN",
    "    CALCULATE (",
    "        [Fact Transfer Cost of Works],",
    "        KEEPFILTERS ( 'Dates'[Date] <= LastFactDate )",
    "    )",
    "        + CALCULATE (",
    "            [Plan Transfer Cost of Works],",
    "            KEEPFILTERS ( 'Dates'[Date] > LastFactDate )",
    "        )"
  ],
  "formatString": "#,0",
  "displayFolder": "01. Project\\02. Expenses\\03. Forecast",
  "detailRowsDefinition": {
    "expression": [
      "VAR LastFactDate =",
      "    MAX ( DatesPlanFact[PF Date] )",
      "RETURN",
      "    UNION (",
      "        CALCULATETABLE (",
      "            SELECTCOLUMNS (",
      "                DETAILROWS ( [Plan Hours] ),",
      "                \"Project\", [Project],",
      "                \"Resource Tribe\", [Plan Resource Tribe],",
      "                \"Project Tribe\", [Project Tribe],",
      "                \"Role\", [Role],",
      "                \"Competence\", [Competence],",
      "                \"BusinessUnit\", [BU],",
      "                \"Date\", [Date],",
      "                \"Fot Rate\", [Fot Rate],",
      "                \"Transfer Rate\", [Transfer Rate],",
      "                \"Hours\", [Plan Hours],",
      "                \"PlanFact Rub\", [Plan Hours] * [Transfer Rate],",
      "                \"PlanFact Fot Rub\", [Plan Hours] * [Fot Rate],",
      "                \"PlanOrFact\", \"Plan\"",
      "            ),",
      "            KEEPFILTERS ( 'Dates'[Date] > LastFactDate ),",
      "            KEEPFILTERS ( 'Resource Tribe'[IsExternalSubcontractTribe] = 0 ),",
      "            KEEPFILTERS ( 'BusinessUnits'[Is Subcontractor] = FALSE () ),",
      "            KEEPFILTERS ( 'PlanHours'[is_subcontract] = 1 ),",
      "            FILTER ( Projects, Projects[incl_for_fin_plan] )",
      "        ),",
      "        CALCULATETABLE (",
      "            SELECTCOLUMNS (",
      "                DETAILROWS ( [Fact Hours] ),",
      "                \"Project\", [Project],",
      "                \"Resource Tribe\", [Employee Tribe],",
      "                \"Project Tribe\", [Project Tribe],",
      "                \"Role\", [Role],",
      "                \"Competence\", [Competence],",
      "                \"BusinessUnit\", [BU],",
      "                \"Date\", [Date],",
      "                \"Fot Rate\", [Fot Rate],",
      "                \"Transfer Rate\", [Transfer Rate],",
      "                \"Hours\", [Fact Hours],",
      "                \"PlanFact Rub\", [Fact Hours] * [Transfer Rate],",
      "                \"PlanFact Fot Rub\", [Fact Hours] * [Fot Rate],",
      "                \"PlanOrFact\", \"Fact\"",
      "            ),",
      "            KEEPFILTERS ( 'Dates'[Date] <= LastFactDate ),",
      "            KEEPFILTERS ( 'FactHours'[IsSubcontract] = 1 ),",
      "            KEEPFILTERS ( 'Resource Tribe'[IsExternalSubcontractTribe] = 0 ),",
      "            KEEPFILTERS ( 'BusinessUnits'[Is Subcontractor] = FALSE () ),",
      "            KEEPFILTERS ( 'Projects'[incl_for_fin_fact] )",
      "        )",
      "    )"
    ]
  }
}