{
  "name": "Fact overhead costs and margin до даты",
  "expression": [
    "VAR maxDate =",
    "    MAX ( Dates[Date] )",
    "RETURN",
    "    CALCULATE (",
    "        [Fact overhead costs and margin],",
    "        FILTER ( ALL ( Dates ), Dates[Date] <= maxDate )",
    "    )"
  ],
  "formatString": "#,##0.00",
  "displayFolder": "16. WIP\\Метрики перенормализации",
  "detailRowsDefinition": {
    "expression": [
      "VAR DateForFot =",
      "    DATE ( 2022, 07, 01 )",
      " ",
      "/*Обычная маржа (FactRub - FactFotRub) до 1 июля по всем проектам*/",
      "VAR MTSD_LAB_Margin_Before_Renorm_Epoch =",
      "    CALCULATE (",
      "        [FactRub] - [FactFotRub],",
      "        KEEPFILTERS ( BusinessUnits[Entity Code] IN { \"1\", \"24\" } ),",
      "        KEEPFILTERS ( FactHours[IsRenormEnabled] IN { 0, 1 } ),",
      "        KEEPFILTERS ( Dates[Date] < DateForFot )",
      "    )",
      "    ",
      "/*Маржа по ТимБадж после 1 июл */ ",
      "VAR MTSD_LAB_TBMargin_After_Renorm_Epoch =",
      "    CALCULATE (",
      "        [TB_Margin],",
      "        KEEPFILTERS ( BusinessUnits[Entity Code] IN { \"1\", \"24\" } ),",
      "        KEEPFILTERS ( TeamBudgeting_Hours_Calculation[IsRenormEnabled] = 1 ),",
      "        KEEPFILTERS ( Dates[Date] >= DateForFot )",
      "    )",
      "    ",
      "/*Маржа по перенормализованным часам для МТСД, Лаб после 1 июл 2022*/",
      "VAR MTSD_LAB_Margin_Renorm_After_Renorm_Epoch =",
      "    CALCULATE (",
      "        [FactRub renorm] - [FactFOT renorm],",
      "        KEEPFILTERS ( BusinessUnits[Entity Code] IN { \"1\", \"24\" } ),",
      "        KEEPFILTERS ( FactHours_Renormilized[IsRenormEnabled] = 0 ),",
      "        KEEPFILTERS ( Dates[Date] >= DateForFot )",
      "    ) ",
      "    ",
      "/*все юрлица кроме МТСД, Лаб и CZ*/",
      "VAR FactMargin_Other =",
      "    CALCULATE (",
      "        [FactRub] - [FactFotRub],",
      "        KEEPFILTERS ( NOT BusinessUnits[Entity Code] IN { \"1\", \"4\", \"24\" } )",
      "    )",
      "    ",
      "VAR FactMarginCZ =",
      "    CALCULATE ( [FactRub], KEEPFILTERS ( BusinessUnits[Entity Code] = \"4\" ) ) * ( 1 / 0.93 - 1 )",
      "",
      "RETURN",
      "    ROW (",
      "        \"MTSD_LAB_Margin_Before_Renorm_Epoch\", MTSD_LAB_Margin_Before_Renorm_Epoch,",
      "        \"MTSD_LAB_TBMargin_After_Renorm_Epoch\", MTSD_LAB_TBMargin_After_Renorm_Epoch,",
      "        \"MTSD_LAB_Margin_Renorm_After_Renorm_Epoch\", MTSD_LAB_Margin_Renorm_After_Renorm_Epoch,",
      "        \"FactMargin_Other\", FactMargin_Other,",
      "        \"FactMarginCZ\", FactMarginCZ,",
      "        \"Fact overhead costs and margin\",",
      "            MTSD_LAB_Margin_Before_Renorm_Epoch + MTSD_LAB_TBMargin_After_Renorm_Epoch + MTSD_LAB_Margin_Renorm_After_Renorm_Epoch + FactMargin_Other + FactMarginCZ",
      "    )"
    ]
  }
}