{
  "name": "Days Presale",
  "expression": [
    "AVERAGEX (",
    "    VALUES ( Projects[Project Code] ),",
    "    VAR _DAYS_WITH_PRESALE_FACT =",
    "        COUNTROWS (",
    "            CALCULATETABLE (",
    "                FILTER (",
    "                    CROSSJOIN (",
    "                        VALUES ( Dates[Date] ),",
    "                        FILTER (",
    "                            ADDCOLUMNS (",
    "                                ADDCOLUMNS (",
    "                                    SUMMARIZE (",
    "                                        Projects,",
    "                                        Projects[Project Code],",
    "                                        Projects[Project Status],",
    "                                        Projects[Min Plan Date G2],",
    "                                        Projects[Project G2 Complete]",
    "                                    ),",
    "                                    \"_MinDate\",",
    "                                        CALCULATE (",
    "                                            CALCULATE (",
    "                                                MIN ( Dates[Date] ),",
    "                                                FILTER ( VALUES ( Dates[DateKey] ), [Fact Hours Presale] > 0 )",
    "                                            ),",
    "                                            ALL ( Dates )",
    "                                        )",
    "                                ),",
    "                                \"_MaxDate\",",
    "                                    VAR _LAST_PRESALE_DATE =",
    "                                        CALCULATE (",
    "                                            CALCULATE (",
    "                                                MAX ( Dates[Date] ),",
    "                                                FILTER ( VALUES ( Dates[DateKey] ), [Fact Hours Presale] > 0 )",
    "                                            ),",
    "                                            ALL ( Dates )",
    "                                        )",
    "                                    VAR _G2_PASS_DATE =",
    "                                        IF (",
    "                                            Projects[Project G2 Complete],",
    "                                            Projects[Min Plan Date G2],",
    "                                            IF ( Projects[Project Status] = \"PRESALE\", TODAY () )",
    "                                        )",
    "                                    RETURN",
    "                                        IF (",
    "                                            _G2_PASS_DATE > 0",
    "                                                && [_MinDate] > 0,",
    "                                            _G2_PASS_DATE - 1,",
    "                                            _LAST_PRESALE_DATE",
    "                                        )",
    "                            ),",
    "                            [_MaxDate] > 0",
    "                        )",
    "                    ),",
    "                    Dates[Date] >= [_MinDate]",
    "                        && Dates[Date] <= [_MaxDate]",
    "                )",
    "            )",
    "        )",
    "    VAR _TOTAL_PROJECT_FACT =",
    "        CALCULATE ( [Fact Hours], ALL ( Dates ) )",
    "    RETURN",
    "        IF ( _TOTAL_PROJECT_FACT > 0, _DAYS_WITH_PRESALE_FACT + 0 )",
    ")"
  ],
  "formatString": "#,##0",
  "displayFolder": "03. Hours\\02. Fact\\01. Presale",
  "detailRowsDefinition": {
    "expression": [
      "CALCULATETABLE (",
      "    ADDCOLUMNS (",
      "        SUMMARIZE (",
      "            Projects,",
      "            Projects[Project],",
      "            Projects[Project Status],",
      "            Projects[Min Plan Date G2],",
      "            Projects[Project G2 Complete]",
      "        ),",
      "        \"Days Presale\", CALCULATE ( [Days Presale] ),",
      "        \"Fact Hours Presale\", CALCULATE ( [Fact Hours Presale] )",
      "    )",
      ")"
    ]
  }
}