{
  "name": "Среднесписочная численность",
  "expression": [
    "ROUND (",
    "    AVERAGEX (",
    "        VALUES ( Dates[Month Date] ),",
    "        VAR cur_m_b =",
    "            CALCULATE ( [Численность на начало периода] )",
    "        VAR cur_m_end =",
    "            CALCULATE ( [Численность на конец периода] )",
    "        VAR cur_m =",
    "            IF ( ISBLANK ( cur_m_b ), cur_m_end, cur_m_b )",
    "        VAR next_m =",
    "            CALCULATE ( [Численность на начало периода], DATEADD ( Dates[Date], 1, MONTH ) )",
    "        VAR next_m1 =",
    "            IF ( ISBLANK ( next_m ), cur_m, next_m )",
    "        RETURN",
    "            ROUND ( ( cur_m + next_m1 ) / 2, 0 )",
    "    ),",
    "    0",
    ")"
  ],
  "formatString": "#,##0",
  "displayFolder": "09. HR\\02. HR - метрики",
  "detailRowsDefinition": {
    "expression": [
      "FILTER (",
      "    ADDCOLUMNS (",
      "        ADDCOLUMNS (",
      "            ADDCOLUMNS (",
      "                DISTINCT ( Dates[Month Date] ),",
      "                \"Численность на начало месяца\",",
      "                VAR cur_m_b =",
      "                    CALCULATE ( [Численность на начало периода] )",
      "                VAR cur_m_end =",
      "                    CALCULATE ( [Численность на конец периода] )",
      "                RETURN",
      "                    IF ( ISBLANK ( cur_m_b ), cur_m_end, cur_m_b )",
      "            ),",
      "            \"Численность на конец месяца\", CALCULATE ( [Численность на начало периода], DATEADD ( Dates[Date], 1, MONTH ) )",
      "        ),",
      "        \"Среднесписочная численность\", ROUND (",
      "            (",
      "                [Численность на начало месяца]",
      "                    + IF (",
      "                        ISBLANK ( [Численность на конец месяца] ),",
      "                        [Численность на начало месяца],",
      "                        [Численность на конец месяца]",
      "                    )",
      "            ) / 2,",
      "            0",
      "        )",
      "    ),",
      "    [Численность на начало месяца] > 0",
      ")"
    ]
  }
}