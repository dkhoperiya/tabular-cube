{
  "name": "Fact/Forecast Revenue G3",
  "description": "Факт / Прогноз дохода по G3",
  "expression": [
    "VAR LastFactDate =",
    "    MAX ( DatesPlanFact[PF Date] )",
    "RETURN",
    "    CALCULATE (",
    "        [Fact Revenue G3],",
    "        FILTER ( FactIncome, FactIncome[fact_date] <= LastFactDate )",
    "    )",
    "        + CALCULATE (",
    "            [Forecast Revenue G3],",
    "            FILTER ( PlanIncome_SumAct, PlanIncome_SumAct[plan_date] > LastFactDate )",
    "        )"
  ],
  "formatString": "#,0",
  "displayFolder": "01. Project\\01. Revenue\\03. Forecast",
  "detailRowsDefinition": {
    "expression": [
      "VAR pm =",
      "    CALCULATE ( SELECTEDVALUE ( Options[Project Probability Mode] ) )",
      "VAR LastFactDate =",
      "    MAX ( DatesPlanFact[PF Date] )",
      "RETURN",
      "    UNION (",
      "        CALCULATETABLE (",
      "            SELECTCOLUMNS (",
      "                FILTER (",
      "                    ADDCOLUMNS (",
      "                        FILTER ( FactIncome, FactIncome[fact_date] <= LastFactDate ),",
      "                        \"Project\", RELATED ( projects[project] ),",
      "                        \"Tribe\", RELATED ( Projects[Project Tribe] ),",
      "                        \"Milestone\", RELATED ( Milestones[Milestone] ),",
      "                        \"Milestone Name\", RELATED ( Milestones[Milestone Name] ),",
      "                        \"Works Status\", RELATED ( Milestones[Works Status] ),",
      "                        \"Fin Act Status\", RELATED ( Milestones[Fin Act Status] ),",
      "                        \"Works Complete\", RELATED ( Milestones[Works Complete] ),",
      "                        \"Plan Date\", RELATED ( Milestones[Plan Date] ),",
      "                        \"KPI Date\", RELATED ( Milestones[KPI date] ),",
      "                        \"Status of Realization\", RELATED ( Milestones[Status of Realization] ),",
      "                        \"Comment\", RELATED ( Milestones[Comment] )",
      "                    ),",
      "                    [Milestone] = \"[G2]\"",
      "                ),",
      "                \"Project\", [Project],",
      "                \"Tribe\", [Tribe],",
      "                \"BuCode\", [BuCode],",
      "                \"Milestone\", [Milestone],",
      "                \"Milestone Name\", [Milestone Name],",
      "                \"Works Statsus\", [Works Status],",
      "                \"Fin Act Status\", [Fin Act Status],",
      "                \"Works Complete\", [Works Complete],",
      "                \"Plan Date\", [Plan Date],",
      "                \"KPI Date\", [KPI date],",
      "                \"Status of Realization\", [Status of Realization],",
      "                \"Comment\", [Comment],",
      "                \"KPI Revenue\", [KPI_Revenue],",
      "                \"Type\", \"Fact\"",
      "            ),",
      "            FILTER ( 'Projects', 'Projects'[Has Revenue] ),",
      "            TREATAS ( VALUES ( Tribes[Tribe Code] ), Milestones[tribe_code] )",
      "        ),",
      "        SELECTCOLUMNS (",
      "            FILTER (",
      "                ADDCOLUMNS (",
      "                    CALCULATETABLE (",
      "                        FILTER ( PlanIncome_SumAct, PlanIncome_SumAct[plan_date] > lastFactDate ),",
      "                        FILTER ( 'Projects', 'Projects'[Has Revenue] ),",
      "                        TREATAS ( VALUES ( Tribes[Tribe Code] ), Milestones[tribe_code] )",
      "                    ),",
      "                    \"Project\", RELATED ( projects[project] ),",
      "                    \"Tribe\", RELATED ( Projects[Project Tribe] ),",
      "                    \"Milestone\", RELATED ( Milestones[Milestone] ),",
      "                    \"Milestone Name\", RELATED ( Milestones[Milestone Name] ),",
      "                    \"Works Status\", RELATED ( Milestones[Works Status] ),",
      "                    \"Fin Act Status\", RELATED ( Milestones[Fin Act Status] ),",
      "                    \"Works Complete\", RELATED ( Milestones[Works Complete] ),",
      "                    \"Plan Date\", RELATED ( Milestones[Plan Date] ),",
      "                    \"KPI Date\", RELATED ( Milestones[KPI date] ),",
      "                    \"Status of Realization\", RELATED ( Milestones[Status of Realization] ),",
      "                    \"Comment\", RELATED ( Milestones[Comment] )",
      "                ),",
      "                [Milestone] = \"[G2]\"",
      "            ),",
      "            \"Project\", [Project],",
      "            \"Tribe\", [Tribe],",
      "            \"BuCode\", [BuCode],",
      "            \"Milestone\", [Milestone],",
      "            \"Milestone Name\", [Milestone Name],",
      "            \"Works Statsus\", [Works Status],",
      "            \"Fin Act Status\", [Fin Act Status],",
      "            \"Works Complete\", [Works Complete],",
      "            \"Plan Date\", [Plan Date],",
      "            \"KPI Date\", [KPI date],",
      "            \"Status of Realization\", [Status of Realization],",
      "            \"Comment\", [Comment],",
      "            \"KPI Revenue\", IF ( pm = \"Full\", [kpi_sum_full], [kpi_sum] ),",
      "            \"Type\", \"Forecast\"",
      "        )",
      "    )"
    ]
  }
}