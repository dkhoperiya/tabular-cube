{
  "name": "Forecast MTS Expenses - G6 MTSIT",
  "description": "Расходы ЮЛ МТС по G6 ЮЛ МТС ИТ",
  "expression": [
    "CALCULATE (",
    "    [Forecast Revenue G6],",
    "    BusinessUnits[Parent Entity Code] = \"1\"",
    ")",
    ""
  ],
  "formatString": "#,##0",
  "displayFolder": "08. BIT Budget",
  "detailRowsDefinition": {
    "expression": [
      "VAR pm =",
      "    CALCULATE ( SELECTEDVALUE ( Options[Project Probability Mode] ) )",
      "VAR LastFactDate =",
      "    MAX ( DatesPlanFact[PF Date] )",
      "RETURN",
      "    UNION (",
      "        CALCULATETABLE (",
      "            SELECTCOLUMNS (",
      "                FILTER (",
      "                    ADDCOLUMNS (",
      "                        FILTER ( FactIncome, FactIncome[fact_date] <= LastFactDate ),",
      "                        \"Project\", RELATED ( projects[project] ),",
      "                        \"Tribe\", RELATED ( Projects[Project Tribe] ),",
      "                        \"Milestone\", RELATED ( Milestones[Milestone] ),",
      "                        \"Milestone Name\", RELATED ( Milestones[Milestone Name] ),",
      "                        \"Works Status\", RELATED ( Milestones[Works Status] ),",
      "                        \"Fin Act Status\", RELATED ( Milestones[Fin Act Status] ),",
      "                        \"Works Complete\", RELATED ( Milestones[Works Complete] ),",
      "                        \"Plan Date\", RELATED ( Milestones[Plan Date] ),",
      "                        \"KPI Date\", RELATED ( Milestones[KPI date] ),",
      "                        \"Status of Realization\", RELATED ( Milestones[Status of Realization] ),",
      "                        \"Comment\", RELATED ( Milestones[Comment] )",
      "                    ),",
      "                    [Milestone] = \"[G6]\"",
      "                ),",
      "                \"Project\", [Project],",
      "                \"Tribe\", [Tribe],",
      "                \"BuCode\", [BuCode],",
      "                \"Milestone\", [Milestone],",
      "                \"Milestone Name\", [Milestone Name],",
      "                \"Works Statsus\", [Works Status],",
      "                \"Fin Act Status\", [Fin Act Status],",
      "                \"Works Complete\", [Works Complete],",
      "                \"Plan Date\", [Plan Date],",
      "                \"KPI Date\", [KPI date],",
      "                \"Status of Realization\", [Status of Realization],",
      "                \"Comment\", [Comment],",
      "                \"KPI Revenue\", [KPI_Revenue],",
      "                \"Type\", \"Fact\"",
      "            ),",
      "            FILTER ( 'Projects', 'Projects'[Has Revenue] ),",
      "            TREATAS ( VALUES ( Tribes[Tribe Code] ), Milestones[tribe_code] ),",
      "            FILTER ( ALL ( BusinessUnits ), BusinessUnits[Parent Entity Name] = \"МТС ИТ\" )",
      "        ),",
      "        SELECTCOLUMNS (",
      "            FILTER (",
      "                ADDCOLUMNS (",
      "                    CALCULATETABLE (",
      "                        FILTER ( PlanIncome_SumAct, PlanIncome_SumAct[plan_date] > lastFactDate ),",
      "                        FILTER ( 'Projects', 'Projects'[Has Revenue] ),",
      "                        TREATAS ( VALUES ( Tribes[Tribe Code] ), Milestones[tribe_code] ),",
      "                        FILTER ( ALL ( BusinessUnits ), BusinessUnits[Parent Entity Name] = \"МТС ИТ\" )",
      "                    ),",
      "                    \"Project\", RELATED ( projects[project] ),",
      "                    \"Tribe\", RELATED ( Projects[Project Tribe] ),",
      "                    \"Milestone\", RELATED ( Milestones[Milestone] ),",
      "                    \"Milestone Name\", RELATED ( Milestones[Milestone Name] ),",
      "                    \"Works Status\", RELATED ( Milestones[Works Status] ),",
      "                    \"Fin Act Status\", RELATED ( Milestones[Fin Act Status] ),",
      "                    \"Works Complete\", RELATED ( Milestones[Works Complete] ),",
      "                    \"Plan Date\", RELATED ( Milestones[Plan Date] ),",
      "                    \"KPI Date\", RELATED ( Milestones[KPI date] ),",
      "                    \"Status of Realization\", RELATED ( Milestones[Status of Realization] ),",
      "                    \"Comment\", RELATED ( Milestones[Comment] )",
      "                ),",
      "                [Milestone] = \"[G6]\"",
      "            ),",
      "            \"Project\", [Project],",
      "            \"Tribe\", [Tribe],",
      "            \"BuCode\", [BuCode],",
      "            \"Milestone\", [Milestone],",
      "            \"Milestone Name\", [Milestone Name],",
      "            \"Works Statsus\", [Works Status],",
      "            \"Fin Act Status\", [Fin Act Status],",
      "            \"Works Complete\", [Works Complete],",
      "            \"Plan Date\", [Plan Date],",
      "            \"KPI Date\", [KPI date],",
      "            \"Status of Realization\", [Status of Realization],",
      "            \"Comment\", [Comment],",
      "            \"KPI Revenue\", IF ( pm = \"Full\", [kpi_sum_full], [kpi_sum] ),",
      "            \"Type\", \"Forecast\"",
      "        )",
      "    )"
    ]
  }
}