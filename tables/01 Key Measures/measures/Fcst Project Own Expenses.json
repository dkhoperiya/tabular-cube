{
  "name": "Fcst Project Own Expenses",
  "description": "Прогноз собственных расходов по проекту. Для закрытых проектов считается по фактическим показателям, для незакрытых по прогнозным. Доход по G6 + доход 2-го уровня от субподряда - расходы на субподряд - внешние расходы/0.93",
  "expression": [
    "//Для незакрытых проектов ",
    "VAR _NOT_CLOSED =",
    "    CALCULATE (",
    "        [Forecast Revenue G6] + [Fcst Tribe Income Subcontracts] ",
    "            - [Fcst Transfer Cost of Works] ",
    "            - ( [Fcst Subcontr Exp] + [Fcst Subcontr CZ Exp] + [Fcst Resold Exp] ) / 0.93,",
    "        KEEPFILTERS ( 'Projects'[Project Status] <> \"Closed\" )",
    "    ) ",
    "//Для закрытых проектов ",
    "VAR _CLOSED =",
    "    CALCULATE (",
    "        [Fact Revenue G6] + [Fact Tribe Income Subcontracts] ",
    "            - [Fact Transfer Cost of Works] ",
    "            - ( [Fact Subcontr Exp] + [Fact Subcontr CZ Exp] + [Fact Resold Exp] ) / 0.93,",
    "        KEEPFILTERS ( 'Projects'[Project Status] = \"Closed\" )",
    "    )",
    "RETURN",
    "    _CLOSED + _NOT_CLOSED"
  ],
  "formatString": "#,##0",
  "displayFolder": "12. Projects Funnel\\01. Project Own Expenses",
  "detailRowsDefinition": {
    "expression": [
      "ADDCOLUMNS (",
      "    FILTER (",
      "        UNION (",
      "            //Для незакрытых проектов ",
      "            ADDCOLUMNS (",
      "                CALCULATETABLE (",
      "                    SUMMARIZE ( Projects, Projects[Project], projects[Project Status] ),",
      "                    KEEPFILTERS ( 'Projects'[Project Status] <> \"Closed\" )",
      "                ),",
      "                \"Revenue G6\", [Forecast Revenue G6],",
      "                \"Tribe Income Subcontracts\", CALCULATE ( [Fcst Tribe Income Subcontracts] ),",
      "                \"Transfer Cost of Works\", CALCULATE ( [Fcst Transfer Cost of Works] ),",
      "                \"Subcontr Exp/0.93\", CALCULATE ( [Fcst Subcontr Exp] ) / 0.93,",
      "                \"Subcontr CZ Exp/0.93\", CALCULATE ( [Fcst Subcontr CZ Exp] ) / 0.93,",
      "                \"Resold Exp/0.93\", CALCULATE ( [Fcst Resold Exp] ) / 0.93,",
      "                \"Type\", \"Прогноз для незакрытых проектов\"",
      "            ),",
      "            //Для закрытых проектов ",
      "            ADDCOLUMNS (",
      "                CALCULATETABLE (",
      "                    SUMMARIZE ( Projects, Projects[Project], projects[Project Status] ),",
      "                    KEEPFILTERS ( 'Projects'[Project Status] = \"Closed\" )",
      "                ),",
      "                \"Revenue G6\", [Fact Revenue G6],",
      "                \"Tribe Income Subcontracts\", CALCULATE ( [Fact Tribe Income Subcontracts] ),",
      "                \"Transfer Cost of Works\", CALCULATE ( [Fact Transfer Cost of Works] ),",
      "                \"Subcontr Exp/0.93\", CALCULATE ( [Fact Subcontr Exp] ) / 0.93,",
      "                \"Subcontr CZ Exp/0.93\", CALCULATE ( [Fact Subcontr CZ Exp] ) / 0.93,",
      "                \"Resold Exp\", CALCULATE ( [Fact Resold Exp] ) / 0.93,",
      "                \"Type\", \"Факт для закрытых проектов\"",
      "            )",
      "        ),",
      "        [Revenue G6] <> BLANK ()",
      "            || [Tribe Income Subcontracts] <> BLANK ()",
      "            || [Transfer Cost of Works] <> BLANK ()",
      "            || [Subcontr Exp/0.93] <> BLANK ()",
      "            || [Subcontr CZ Exp/0.93] <> BLANK ()",
      "            || [Resold Exp/0.93] <> BLANK ()",
      "    ),",
      "    \"Fcst Project Own Expenses\", [Revenue G6] + [Tribe Income Subcontracts] - [Transfer Cost of Works] - [Subcontr Exp/0.93] - [Subcontr CZ Exp/0.93] - [Resold Exp/0.93]",
      ")"
    ]
  }
}